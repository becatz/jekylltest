<!DOCTYPE html>
<html ng-app="MyApp">
<head>
    <title>FirstMedia</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.1/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.7/angular.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-router/0.2.13/angular-ui-router.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/0.12.0/ui-bootstrap-tpls.min.js"></script>
</head>
<body class="container">

    <nav class="navbar navbar-default" role="navigation">
        <a class="navbar-brand" href="/">NNDDCC</a>
    </nav>

    <h2>FirstMedia Schedule</h2>

    <br />

    <div ng-controller="MyCtrl">

        <form ng-submit="getschedule()" class="form-inline">

            <div class="form-group">
                <div class="input-group">
                    <input ng-model="data.showdate"
                           type="text" class="form-control" placeholder="Date"
                           datepicker-popup="EEE dd MMM yyyy" />
                </div>
            </div>

            <div class="form-group">
                <div class="input-group">
                    <input ng-model="vm.Channel"
                           type="text" class="form-control" placeholder="Channel"
                           typeahead="c.label + ' (' + c.id + ')' for c in vm.ChannelTypeAhead($viewValue)"
                           typeahead-on-select="vm.ChannelOnSelect($item, $model, $label)"
                           typeahead-editable="false" />
                </div>
            </div>

            <div class="form-group">
                <div class="input-group">
                    <button type="submit" class="btn btn-default">Get</button>
                </div>
            </div>

        </form>

        <div class="col-sm-2">
            <div class="radio" ng-repeat="channel in channels">
                <label>
                    <input type="radio" ng-model="data.channels" ng-value="channel.id" ng-click="getschedule()" />
                    {{channel.label}}
                </label>
            </div>
        </div>

        <div class="col-sm-10">
            <table class="table" ng-repeat="channel in schedules">
                <caption>{{channel.Channel}}</caption>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Title</th>
                        <th>Description</th>
                        <th>Length</th>
                    </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="show in channel.Schedules">
                        <td>{{show.ShowTime}}</td>
                        <td>{{show.Title}}</td>
                        <td>{{show.Description}}</td>
                        <td>{{show.Length}}</td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>

    <script>
        "use strict";

        angular.module('MyApp', ['ui.router', 'ui.bootstrap']);

        angular.module("MyApp").controller("MyCtrl", [
            "$scope", "$http",
            function ($scope, $http) {

                $scope.data = {
                    showdate: moment({ hour: 0 }).format("ddd DD MMM YYYY"),
                    channels: null
                };

                $scope.vm = {};

                $scope.vm.Channel = null;
                $scope.vm.ChannelTypeAhead = function (keyword) {
                    var filtered = _.filter($scope.channels, function (c) {
                        return c.label.toLowerCase().indexOf(keyword.toLowerCase()) > -1;
                    });
                    return filtered;
                };
                $scope.vm.ChannelOnSelect = function (item, model, label) {
                    $scope.data.channels = item.id;
                };

                $scope.getschedule = function () {
                    $http({
                        method: "GET",
                        url: "https://uspcahharhjy5eb4.apphb.com/firstmedia/schedules",
                        params: $scope.data
                    }).then(function (response) {
                        $scope.schedules = response.data;
                        _.each($scope.schedules, function (c) {
                            _.each(c.Schedules, function (s) {
                                s.ShowTime = moment(s.ShowTime).format("ddd HH:mm");
                            });
                        });
                    });
                };

                $http({
                    method: "GET",
                    url: "https://uspcahharhjy5eb4.apphb.com/firstmedia/channels"
                }).then(function (response) {
                    $scope.channels = _.sortBy(response.data, function (c) {
                        return c.label;
                    });
                });

            }
        ]);

    </script>

</body>
</html>
